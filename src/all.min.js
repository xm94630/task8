/* 作者：xm94630
 * 创建实例
 * angular.module第一个参数是模块“引用名”，模块间可以通过它引入依赖
 * 第11行代码中括号中就是通过“引用名”对模块的依赖引用，模块也可以理解为类似插件、服务的概念
 * “ui.bootstrap”模块定义是在script标签中引入的
 */
var	appServices    = angular.module('xmApp.services',[]),
    appDirectives  = angular.module('xmApp.directives',[]),
    appControllers = angular.module('xmApp.controllers',[]),
    appFilters     = angular.module('xmApp.filters',[]),
    xmApp          = angular.module('XM',['ui.router','ui.bootstrap','xmApp.services','xmApp.directives','xmApp.controllers','xmApp.filters']);
 
xmApp
	//全局变量注入
	.constant('HERO',{
		HP:1000,
		MP:2000
	})
    .run(["$rootScope", "$state", "$stateParams", function($rootScope, $state, $stateParams) {
    	//绑到根作用域，方便获得当前状态
        $rootScope.$state = $state;
        $rootScope.$stateParams = $stateParams;
    }]);
xmApp
    .config(["$stateProvider", "$urlRouterProvider", function($stateProvider, $urlRouterProvider) {

        $stateProvider
            .state('home', {
                url: '/home',
                views: {
                    'xmContent': {
                        templateUrl: './html/module/home.html',
                        controller: 'homeCtrl'
                    }
                }
            });

        $urlRouterProvider
            .otherwise('/home');

    }]);
//自定义服务
appServices.factory('XmService', ["$rootScope", function ($rootScope) {
    return {
        splat:function(fun){
        	return function(array){
        		return fun.apply(null,array);
        	}
        }
    };
}]);
appDirectives.directive('chosenDirective', ["$timeout", function($timeout) {
    return {
        scope: {
            'setSelected': '=',
            'changeFunction': '=',
            'chosenData': '='
        },
        require: "?ngModel",
        restrict: 'A', // E = Element, A = Attribute, C = Class, M = Comment
        templateUrl: './html/directive/chosen.html',
        transclude: true,
        compile: function(tEle, tAttr, transcludeFn) {
            return function(scope, element, attrs, ngModel) {
                var _defaultResult = [];
                scope.isOpen = false;
                //是否显示搜索
                scope.chosenSearch = !attrs['isHaveSearch'];
                //是否单选
                scope.isSingle = !attrs['isMulit'] || false;

                var selectedDom = [],
                    selectedClass = 'highlighted';

                scope.mouseover = function(e) {
                    if (optionStatus(angular.element(e.target))) return;
                    angular.element(e.target).addClass('highlighted');
                }
                scope.mouseleave = function(e) {
                    if (optionStatus(angular.element(e.target))) return;
                    angular.element(e.target).removeClass('highlighted');
                }
                scope.clickoption = function(e) {
                    if (optionStatus(angular.element(e.target))) return;
                    //重置
                    scope.searchVal = '';
                    scope.results = _defaultResult;

                    setSelected(angular.element(e.target));
                    scope.isOpen = false;
                }

                scope.openDrop = function() {
                    scope.isOpen = !scope.isOpen;
                }

                scope.searchOption = function(val) {
                    var _list = [];
                    var _reg = new RegExp(val, 'g');

                    for (var i = 0; i < _defaultResult.length; i++) {
                        if (_defaultResult[i].label.search(_reg) != -1) {
                            _list.push(_defaultResult[i]);
                        }
                    }
                    scope.results = _list;
                }


                scope.removeSelected = function(index, e) {
                    e.stopPropagation();
                    selectedDom[index].removeClass('result-selected');
                    selectedDom.splice(index, 1);
                    scope.currentOption.splice(index, 1);
                    changeFunctions();
                }

                function optionStatus(dom) {
                    var _result = false;
                    if (dom.hasClass('group-result') || dom.hasClass('result-selected')) {
                        _result = true;
                    }
                    return _result;
                }

                function setSelected(dom) {
                    var _selected,
                        _dom,
                        _val = dom.text();
                    dom.removeClass('highlighted');
                    if (attrs['isMulit']) {
                        _selected = scope.currentOption;
                        _dom = selectedDom;
                        selectedDom.push(dom);
                        _selected.push(_val);
                    } else {
                        _selected = _val;
                        if (selectedDom.length != 0) {
                            selectedDom[0].removeClass('highlighted');
                        }
                        selectedDom = [dom];
                    }
                    scope.currentOption = _selected;
                    changeFunctions();
                }

                function getSelectedValue() {
                    var _val = [];
                    for (var i = 0; i < selectedDom.length; i++) {
                        _val.push(selectedDom[i].attr('data-value'));
                    }
                    return _val;
                }

                function changeFunctions() {
                    var _cur = scope.currentOption;
                    if (angular.isFunction(scope.changeFunction)) {
                        if (!!ngModel) {
                            ngModel.$setViewValue(getSelectedValue());
                        }
                        scope.changeFunction(_cur, getSelectedValue());
                    }
                    scope.$emit('chosenChange', scope.currentOption, getSelectedValue());
                }

                function createDom() {
                    transcludeFn(scope, function(clone) {
                        var _results = [];
                        if (clone.length == 0) {
                            return;
                        }
                        for (var i = 0; i < clone.length; i++) {
                            if (clone[i].nodeType == 1) {
                                if (clone[i].tagName == 'OPTGROUP') {
                                    _results.push({
                                        label: clone[i].label,
                                        group: 'title'
                                    });
                                    if (clone[i].children.length > 0) {
                                        for (var j = clone[i].children.length - 1; j >= 0; j--) {
                                            _results.push({
                                                label: clone[i].children[j].label,
                                                group: 'option',
                                                value: clone[i].children[j].value
                                            });

                                        }
                                    }
                                } else {
                                    _results.push({
                                        label: clone[i].label,
                                        group: 'none',
                                        value: clone[i].value
                                    })
                                }
                            }
                        }
                        _defaultResult = _results;
                        scope.results = _results;
                        scope.currentOption = clone[1].label;
                    });
                }

                function setChosenSelected() {
                    if (scope.setSelected != undefined && scope.setSelected.length != 0) {
                        var _option = element[0].querySelectorAll('.chosen-results li');
                        var index = 0;
                        setFor:
                            for (var j = 0; j < scope.setSelected.length; j++) {
                                for (var i = 0; i < _option.length; i++) {
                                    if (angular.element(_option[i]).attr('data-value') == scope.setSelected[j]) {
                                        setSelected(angular.element(_option[i]));
                                        index++;
                                        break setFor;
                                    }
                                }
                            }
                        if (index <= 0) {
                            setSelected(angular.element(_option[0]));
                        }
                    }
                }

                function addWatch() {

                    var _body = angular.element(document.getElementsByTagName('body'));

                    scope.$watch('isOpen', function() {
                        for (var i = 0; i < selectedDom.length; i++) {
                            selectedDom[i].addClass(selectedClass);
                        }
                        if (scope.isOpen == true) {
                            $timeout(function() {
                                _body.bind('click', function(e) {
                                    var _parent = angular.element(e.target);
                                    for (var i = 0; i < 5; i++) {
                                        if (_parent.parent().length == 0) {
                                            break
                                        }
                                        if (element[0] == _parent.parent()[0]) {
                                            return false
                                        } else {
                                            _parent = _parent.parent();
                                        }
                                    }
                                    scope.$apply(function() {
                                        scope.isOpen = false;
                                    });
                                });
                            }, 10);
                        } else {
                            _body.unbind('click');
                        }
                    })

                    if (attrs['isMulit']) {
                        scope.currentOption = [];
                        selectedDom = [];
                        selectedClass = 'result-selected';
                        // scope.multiValue = '请选择一些选项';
                        scope.$watch('currentOption.length', function() {
                            if (scope.currentOption.length != 0) {
                                scope.multiValue = '';
                                scope.multiwidth = '25px';
                            } else {
                                scope.multiValue = '请选择一些选项';
                                scope.multiwidth = 'auto';
                            }
                        })
                    }

                    scope.$watch('setSelected', function() {
                        $timeout(setChosenSelected, 20);
                    })

                }

                function init() {
                    // console.log(scope.chosenData)
                    if (scope.chosenData != undefined) {
                        _defaultResult = scope.chosenData;
                        scope.results = scope.chosenData;
                        scope.currentOption = scope.chosenData[0].label;
                        scope.$watch('chosenData', function() {
                            _defaultResult = scope.chosenData;
                            scope.results = scope.chosenData;
                            scope.currentOption = scope.chosenData[0].label;
                        })
                    } else {
                        createDom();
                    }
                    addWatch();
                }

                init();
            };
        },
        replace: true
    };
}])

appDirectives.directive('datePigDirective', ["$rootScope", function($rootScope) {
	return {
	    restrict: 'AE',
	    replace: 'true',
	    templateUrl: './html/directive/datePig.html',
	    //这里的值来自于指令上
	    scope: {
	        dateInfo: "="
	    },
	    //controller中的代码会比link中的先行
	    //另外controller中的$scope和link中的scope是同一个对象
	    //controller可用于实现指令之间的通讯
	    controller:["$scope", function($scope){
	    }],
	    link:function(scope,element,attrs){

	    	//比较有意思的几组关系
	    	//l(element[0] == document.getElementById("date"))
	    	//l(scope == $rootScope.$$childHead)
	    	//l(scope == $rootScope.$$childTail)
	    	//l(scope.$parent == $rootScope)
	    	
	    	//通过attrs可以获取指令属性，注意如果是以xxx-yyy的属性，在这里读取的是xxxYyy格式
	    	//这样子得到的属性值是没有渲染的。
	    	//l(attrs.dateInfo);

			//时间参数对象
			var t = null;
			var defaultYearList = {
				group: "none",
				label:"年份",
				value: "-1"
			};
			var defaultMonthList = {
				group: "none",
				label:"月份",
				value: "-1"
			};

			var isArray = Array.isArray || function(obj){
				return Object.prototype.toString.call(obj) == '[object Array]';
			}

			function isString(obj){
				return Object.prototype.toString.call(obj) == '[object String]';
			}

			function isNumber(obj){
				return Object.prototype.toString.call(obj) == '[object Number]';
			}

			function error(info){
				throw new Error(info);
			}

			function warn(info){
				console.log('[warn]'+info);
			}

			//解析实例时所用的参数，返回对象
			function parseParameter(data){

				var sTime_min = data.sTime[0]; //开始时间 可选最小范围				
				    sTime_max = data.sTime[1]; //开始时间 可选最大范围				
				    eTime_min = data.eTime[0]; //结束时间 可选最小范围			
				    eTime_max = data.eTime[1]; //结束时间 可选最大范围
				
				return {
					s:{
					    min:{
					    	year  : parseInt(sTime_min.split('/')[0]),
					    	month : parseInt(sTime_min.split('/')[1])
					    },
					    max:{
					    	year  : parseInt(sTime_max.split('/')[0]),
					    	month : parseInt(sTime_max.split('/')[1])
					    }
					},
					e:{
						min:{
							year  : parseInt(eTime_min.split('/')[0]),
							month : parseInt(eTime_min.split('/')[1])
						},
						max:{
							year  : parseInt(eTime_max.split('/')[0]),
							month : parseInt(eTime_max.split('/')[1])
						}
					}
				}

			}

			/* 
			 * 时间大小比较
			 * 支持单独的年、月、组合年月大小的比较，用法：
			 * greaterThan([1998,2],[1998,1]) 返回true
			 * greaterThan(1998,1997) 返回true
			 */
			function greaterThan(time1,time2){
				if(isNumber(time1) && isNumber(time2)){
					if(time1>time2) return true; 
				}else if(isArray(time1) && isArray(time2)){
					var a = time1[0],  
						b = time1[1],
						c = time2[0],
						d = time2[1];
					if(a>c||(a==c)&&(b>d)){
						return true;
					}
				}else{
					error('greaterThan:参数类型有误！');
				}
				return false;
			}

			function equalTo(time1,time2){
				if(isNumber(time1) && isNumber(time2)){
					if(time1==time2) return true; 
				}else if(isArray(time1) && isArray(time2)){
					var a = time1[0],  
						b = time1[1],
						c = time2[0],
						d = time2[1];
					if((a==c)&&(b==d)){
						return true;
					}
				}else{
					error('greaterThan:参数类型有误！');
				}
				return false;
			}

			function lessThan(time1,time2){
				return !greaterThan(time1,time2) && !equalTo(time1,time2);
			}

			//获取时间间隔,以月份为返回单位
			//getInterval([2001,1],[2003,12])
			function getInterval(time1,time2){
				var a = time1[0],  
					b = time1[1],
					c = time2[0],
					d = time2[1];
				if (greaterThan(time1,time2)) return;
				if(c>=a && d>=b){
					//时间间隔为一年以上
					return (c-a)*12+(d-b)+1; 
				}else if(c>a && d<b){
					//时间间隔为一年以及一年以内
					return ((c-1)-a)*12+((12+d)-b);
				}

			}

			/* 
			 * 时间校验规则
			 * 传入两个时间，比较器函数，回调函数
			 * 当满足比较器时，触发回调
			 */
			function rule(time1,time2,comparator,fun){
				if(comparator(time1,time2)) fun();
			}

			//校验并修正数据,返回修正后的对象
			function checkTime(t){

				var sMinY = t.s.min.year;
				var sMinM = t.s.min.month;
				var sMaxY = t.s.max.year;
				var sMaxM = t.s.max.month;
				var eMinY = t.e.min.year;
				var eMinM = t.e.min.month;
				var eMaxY = t.e.max.year;
				var eMaxM = t.e.max.month;

				//校验
				rule([sMinY,sMinM],[sMaxY,sMaxM],greaterThan,function(){
					error('开始时间的最小范围不得大于最大范围!');
				});
				rule([eMinY,eMinM],[eMaxY,eMaxM],greaterThan,function(){
					error('结束时间的最小范围不得大于最大范围!');
				});
				rule([sMinY,sMinM],[eMinY,eMinM],greaterThan,function(){
					warn('开始时间的最小范围大于结束时间的最小范围，系统已调整');
					t.e.min.year  = sMinY;
					t.e.min.month = sMinM;
				});
				return t;

			}
            
            //获取年份的范围
            //getRangeByYear([2002,1],[2010,12])
			function getRangeByYear(time1,time2){
				var i,arr = [],
					a = time1[0],  
					b = time1[1],
					c = time2[0],
					d = time2[1];
				if (greaterThan(time1,time2)) return;
				for(i=a;i<=c;i++){
					arr.push(i);
				}
				return arr;
			}



            //获取月份的范围
            //getRangeByYear([2002,1],[2010,12])
			function getRangeByMonth(time1,time2){
				var i,arr = [],
					a = time1[0],  
					b = time1[1],
					c = time2[0],
					d = time2[1];
				if (greaterThan(time1,time2)) return;
				//超过12月，所有月份可选
				if(getInterval(time1,time2)>=12){
					for(i=1;i<=12;i++){
						arr.push(i);
					}
					return arr;
				//不到12月
				}else{
				 	//同年
					if(a==c){
						for(i=b;i<=d;i++){
							arr.push(i);
						}
						return arr;
					//隔年
					}else{
						for(i=b;i<=12;i++){
							arr.push(i);
						}
						for(i=1;i<=d;i++){
							arr.push(i);
						}
						arr.sort(function(x,y){
							return x>y;
						})
						return arr;
					}
				}
				return;
			}

 			//组装chose所需的数据格式
 			function packageData(defaultObj,rangeArr){
 				var arr = [];
 				arr.push(defaultObj);
 				l(rangeArr)
 				rangeArr.forEach(function(item){
 					arr.push({
 						group: "none",
	 				    label: item,
	 				    value: item
 					});
 				});
 				return arr;
 			}



			//获取时间参数对象
			t = parseParameter(scope.dateInfo);
			//校验时间
			t = checkTime(t);
			l(t);

			//实例化chosen
 			scope.chosendata1 = packageData(defaultYearList, getRangeByYear ([t.s.min.year,t.s.min.month],[t.s.max.year,t.s.max.month]));
 			scope.chosendata2 = packageData(defaultMonthList,getRangeByMonth([t.s.min.year,t.s.min.month],[t.s.max.year,t.s.max.month]));
 			scope.chosendata3 = packageData(defaultYearList, getRangeByYear ([t.e.min.year,t.e.min.month],[t.e.max.year,t.e.max.month]));
 			scope.chosendata4 = packageData(defaultMonthList,getRangeByMonth([t.e.min.year,t.e.min.month],[t.e.max.year,t.e.max.month]));
 			scope.chosendata = {
 				item1:{
 					data:scope.chosendata1,
 					change:function(label,value){
 						l(1)
 					}
 				},
 				item2:{
 					data:scope.chosendata2,
 					change:function(label,value){
 						l(2)
 					}
 				},
 				item3:{
 					data:scope.chosendata3,
 					change:function(label,value){
 						l(3)
 					}
 				},
 				item4:{
 					data:scope.chosendata4,
 					change:function(label,value){
 						l(4)
 					}
 				}
 			}

 			//获取两个数之间以1递增的序列，以数组形式返回
 			//getRange(3,6); -> 返回[3,4,5,6]
 			function getRange(a,b){
 				var i,
 					arr=[];
 				if(a>b) return error('getRange:第一个参数必须小于第二个参数');
 				for(i=a;i<=b;i++){
 					arr.push(i);
 				}
 				return arr;
 			}

 			//是否同年
 			function isSameYear(time1,time2){
 				if(getRangeByYear(time1,time2).length==1){
 					return true;
 				}
 			}

 			//是否跨年
 			function isTransYear(time1,time2){
 				if(getRangeByYear(time1,time2).length==2){
 					return true;
 				}
 			}

 			//是否多年
 			function isSeveralYear(){
 				if(getRangeByYear(time1,time2).length>2){
 					return true;
 				}
 			}

 			//高阶函数，做闭包用
 			function getValid(time1,time2){
 				return function(type,x){
 					var i,
 					    arr = [],
 					    obj = {},
 						a   = time1[0],  
 						b   = time1[1],
 						c   = time2[0],
 						d   = time2[1];

 					if(type=='year'){
 						alert(1)
 						if(isSameYear(time1,time2)){
 							alert(2)
 							obj[a] = getRange(b,d);
 						}else if(isTransYear(time1,time2)){
 							alert(3)
 							obj[a] = getRange(b,12);
 							obj[c] = getRange(1,d);
 						}else if(isSeveralYear(time1,time2)){
 							alert(123);
 							for(i=a;i<c;i++){
 								if(i==a){
									obj[a] = getRange(b,12);
 								}else if(i==c){
 									obj[c] = getRange(1,d);
 								}else{
 									obj[i] = getRange(1,12);
 								}
 							}
 						}
 						alert(222)

 					}else if(type=='month'){

 					}

 					return obj[x];

 				}

 			}

 			l(getValid([2010,6],[2016,8])('year' ,2011));
 			//getValid([2010,6],[2011,3])('month',12);
 			







	    }
	};
}]);

/**
 * Created by Administrator on 2016/1/27.
 */
appControllers.controller("homeCtrl",["$scope", "XmService", function($scope,XmService){

	//这里使用了服务
	var value = XmService.splat(function(x,y){
		return x+y;
	})([1400,8127]);

	//这部分数据是传递给指令用的，用来作为指令的参数
	$scope.pigData={
		/*sTime : ['2016/1','2018/5'],
		eTime : ['2000/5','2019/9']*/
		sTime : ['2016/1','2016/12'],
		eTime : ['2017/9','2018/2']
	};

}]);